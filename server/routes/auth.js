// ========== ИМПОРТЫ ==========

// Импортируем Express для создания роутера
import express from 'express';

// Импортируем bcrypt для хеширования паролей
import bcrypt from 'bcryptjs';

// Импортируем jsonwebtoken для создания JWT токенов
import jwt from 'jsonwebtoken';

// Импортируем модель пользователя
import User from '../models/User.js';

// ======================================================


// ========== СОЗДАНИЕ РОУТЕРА ==========

// Создаём роутер — объект для обработки запросов
const router = express.Router();

// ======================================================


// ========== РОУТ 1: РЕГИСТРАЦИЯ (/register) ==========

// POST /api/auth/register
// Тело запроса: { username, email, password }
router.post('/register', async (req, res) => {
  try {
    // ======================================================
    // ШАГ 1: Получаем данные из тела запроса
    // ======================================================
    
    const { username, email, password } = req.body;
    // req.body — это данные, которые пришли от фронтенда
    // Например: { username: "john", email: "john@example.com", password: "123456" }

    // ======================================================
    // ШАГ 2: Проверяем, что все поля заполнены
    // ======================================================
    
    if (!username || !email || !password) {
      // Если какое-то поле пустое, возвращаем ошибку 400 (Bad Request)
      return res.status(400).json({ 
        message: 'Все поля обязательны' 
      });
    }

    // ======================================================
    // ШАГ 3: Проверяем, существует ли пользователь с таким email или именем
    // ======================================================
    
    // Ищем пользователя в базе данных
    const existingUser = await User.findOne({ 
      $or: [{ email }, { username }] 
      // $or — оператор MongoDB: ищет по email ИЛИ по username
    });

    // Если пользователь найден
    if (existingUser) {
      return res.status(400).json({ 
        message: 'Пользователь с таким email или именем уже существует' 
      });
    }

    // ======================================================
    // ШАГ 4: Хешируем пароль
    // ======================================================
    
    // Хешируем пароль перед сохранением в БД
    // 10 — количество раундов хеширования (чем больше, тем безопаснее, но медленнее)
    const hashedPassword = await bcrypt.hash(password, 10);

    // ======================================================
    // ШАГ 5: Создаём нового пользователя
    // ======================================================
    
    // Создаём документ пользователя
    const user = new User({
      username,
      email,
      password: hashedPassword  // Сохраняем хешированный пароль!
    });

    // Сохраняем пользователя в базу данных
    await user.save();
    // user.save() — метод Mongoose для сохранения документа

    // ======================================================
    // ШАГ 6: Создаём JWT токен
    // ======================================================
    
    // JWT (JSON Web Token) — это токен для аутентификации
    // Содержит информацию о пользователе и срок действия
    const token = jwt.sign(
      { 
        userId: user._id,   // ID пользователя
        email: user.email   // Email пользователя
      },
      process.env.JWT_SECRET,  // Секретный ключ для подписи токена
      { expiresIn: '7d' }      // Токен действителен 7 дней
    );

    // ======================================================
    // ШАГ 7: Отправляем ответ фронтенду
    // ======================================================
    
    res.status(201).json({
      message: 'Пользователь успешно зарегистрирован',
      token,  // Отправляем токен
      user: {
        id: user._id,
        username: user.username,
        email: user.email
        // Пароль НЕ отправляем!
      }
    });

  } catch (error) {
    // Если произошла ошибка
    console.error('Ошибка регистрации:', error);
    res.status(500).json({ 
      message: 'Ошибка сервера', 
      error: error.message 
    });
  }
});

// ======================================================


// ========== РОУТ 2: ВХОД В СИСТЕМУ (/login) ==========

// POST /api/auth/login
// Тело запроса: { email, password }
router.post('/login', async (req, res) => {
  try {
    // ======================================================
    // ШАГ 1: Получаем данные из тела запроса
    // ======================================================
    
    const { email, password } = req.body;

    // ======================================================
    // ШАГ 2: Проверяем, что все поля заполнены
    // ======================================================
    
    if (!email || !password) {
      return res.status(400).json({ 
        message: 'Email и пароль обязательны' 
      });
    }

    // ======================================================
    // ШАГ 3: Ищем пользователя по email
    // ======================================================
    
    const user = await User.findOne({ email });
    // Если пользователя нет, возвращаем ошибку
    if (!user) {
      return res.status(401).json({ 
        message: 'Неверный email или пароль' 
      });
    }

    // ======================================================
    // ШАГ 4: Проверяем пароль
    // ======================================================
    
    // Сравниваем введённый пароль с хешированным паролем из БД
    const isPasswordValid = await bcrypt.compare(password, user.password);
    
    // Если пароли не совпадают
    if (!isPasswordValid) {
      return res.status(401).json({ 
        message: 'Неверный email или пароль' 
      });
    }

    // ======================================================
    // ШАГ 5: Создаём JWT токен
    // ======================================================
    
    const token = jwt.sign(
      { 
        userId: user._id, 
        email: user.email 
      },
      process.env.JWT_SECRET,
      { expiresIn: '7d' }
    );

    // ======================================================
    // ШАГ 6: Отправляем ответ
    // ======================================================
    
    res.json({
      message: 'Успешный вход',
      token,
      user: {
        id: user._id,
        username: user.username,
        email: user.email
      }
    });

  } catch (error) {
    console.error('Ошибка логина:', error);
    res.status(500).json({ 
      message: 'Ошибка сервера' 
    });
  }
});

// ======================================================


// ========== РОУТ 3: ПОЛУЧЕНИЕ ДАННЫХ ПОЛЬЗОВАТЕЛЯ (/me) ==========

// GET /api/auth/me
// Заголовок: Authorization: Bearer <токен>
router.get('/me', async (req, res) => {
  try {
    // ======================================================
    // ШАГ 1: Получаем токен из заголовка запроса
    // ======================================================
    
    // Заголовок выглядит так: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    const authHeader = req.headers.authorization;
    // Разбиваем на части: ["Bearer", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."]
    const token = authHeader?.split(' ')[1];
    
    // Если токена нет
    if (!token) {
      return res.status(401).json({ 
        message: 'Токен не предоставлен' 
      });
    }

    // ======================================================
    // ШАГ 2: Верифицируем (проверяем) токен
    // ======================================================
    
    // jwt.verify проверяет:
    // 1. Действителен ли токен
    // 2. Не просрочен ли он
    // 3. Подписан ли он правильным секретным ключом
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    // decoded содержит: { userId: "...", email: "...", iat: ..., exp: ... }

    // ======================================================
    // ШАГ 3: Ищем пользователя по ID из токена
    // ======================================================
    
    // Ищем пользователя в базе данных
    const user = await User.findById(decoded.userId).select('-password');
    // .select('-password') — не включаем пароль в результат
    
    // Если пользователя нет
    if (!user) {
      return res.status(404).json({ 
        message: 'Пользователь не найден' 
      });
    }

    // ======================================================
    // ШАГ 4: Отправляем данные пользователя
    // ======================================================
    
    res.json({
      user: {
        id: user._id,
        username: user.username,
        email: user.email
      }
    });

  } catch (error) {
    console.error('Ошибка получения профиля:', error);
    res.status(401).json({ 
      message: 'Неверный или просроченный токен' 
    });
  }
});

// ======================================================


// ========== ЭКСПОРТ РОУТЕРА ==========

// Экспортируем роутер, чтобы использовать его в server.js
export default router;

// ======================================================