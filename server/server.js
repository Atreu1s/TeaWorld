import express from 'express';
import mongoose from 'mongoose';
import cors from 'cors';
import dotenv from 'dotenv';
import authRoutes from './routes/auth.js';
import blogRoutes from './routes/blog.js'; 

// ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞
// –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å process.env.PORT, process.env.MONGODB_URI –∏ —Ç.–¥.
dotenv.config();

// –°–æ–∑–¥–∞—ë–º Express –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
const app = express();

// –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å–µ—Ä–≤–µ—Ä (–∏–∑ .env –∏–ª–∏ 5000 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
const PORT = process.env.PORT || 5000;

// ======================================================


// ========== MIDDLEWARE (–ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û) ==========

// –í–∫–ª—é—á–∞–µ–º CORS ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (http://localhost:5173)
app.use(cors());

// –ü–∞—Ä—Å–∏–º JSON –∏–∑ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞ (—á—Ç–æ–±—ã req.body —Ä–∞–±–æ—Ç–∞–ª)
app.use(express.json());

// –ü–∞—Ä—Å–∏–º URL-encoded –¥–∞–Ω–Ω—ã–µ (—Ñ–æ—Ä–º—ã)
app.use(express.urlencoded({ extended: true }));

// ======================================================


// ========== –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ë–ê–ó–ï –î–ê–ù–ù–´–• ==========

// –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ MongoDB
mongoose.connect(process.env.MONGODB_URI)
  .then(() => {
    // –ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
    console.log('‚úÖ MongoDB –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
  })
  .catch((err) => {
    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', err);
  });

// ======================================================


// ========== –†–û–£–¢–´ (–º–∞—Ä—à—Ä—É—Ç—ã) ==========

app.use('/api/auth', authRoutes);
app.use('/api/blog', blogRoutes);

// ======================================================


// ========== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–û–£–¢–´ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏) ==========

// –†–æ—É—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ —Å–µ—Ä–≤–µ—Ä
// –ó–∞–ø—Ä–æ—Å: GET http://localhost:5000/api/health
app.get('/api/health', (req, res) => {
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º JSON –æ—Ç–≤–µ—Ç
  res.json({ 
    status: 'OK', 
    message: '–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç' 
  });
});

// ======================================================


// ========== –û–ë–†–ê–ë–û–¢–ö–ê 404 (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞) ==========

// –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—à—ë–ª –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–æ—É—Ç
app.use((req, res) => {
  res.status(404).json({ 
    message: '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' 
  });
});

// ====================================================== 
// –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Ctrl + C
  process.on('SIGINT', async () => {
  console.log('\nüîå –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞...');
  await mongoose.connection.close();
  console.log('‚úÖ MongoDB –æ—Ç–∫–ª—é—á–µ–Ω–∞');
  process.exit(0);
});

// ========== –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ==========

// –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–º –ø–æ—Ä—Ç—É
app.listen(PORT, () => {
  console.log(`üöÄ –ë—ç–∫–µ–Ω–¥ –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:${PORT}`);
});

// ======================================================